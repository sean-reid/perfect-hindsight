<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Perfect Hindsight</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@300;400;500&family=Newsreader:ital,opsz,wght@0,6..72,300;0,6..72,400;0,6..72,500;1,6..72,300;1,6..72,400&display=swap" rel="stylesheet">
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  :root {
    --bg: #faf9f6;
    --ink: #1a1a18;
    --ink2: #5c5c58;
    --ink3: #9c9c96;
    --rule: #d8d6d0;
    --accent: #b91c1c;
    --green: #15803d;
    --serif: 'Newsreader', Georgia, serif;
    --mono: 'DM Mono', 'Menlo', monospace;
  }

  html { font-size: 17px; }
  body {
    background: var(--bg);
    color: var(--ink);
    font-family: var(--serif);
    line-height: 1.55;
    -webkit-font-smoothing: antialiased;
    min-height: 100vh;
  }
  ::selection { background: var(--accent); color: #fff; }

  .container { max-width: 860px; margin: 0 auto; padding: 3rem 1.5rem 4rem; }

  header {
    margin-bottom: 2.5rem;
    padding-bottom: 1.5rem;
    border-bottom: 1px solid var(--ink);
  }
  header h1 {
    font-size: 2rem;
    font-weight: 400;
    letter-spacing: -0.03em;
    line-height: 1.15;
    margin-bottom: 0.35rem;
  }
  header p {
    font-size: 0.82rem;
    color: var(--ink2);
    font-style: italic;
    max-width: 52ch;
  }

  .controls {
    display: flex;
    align-items: baseline;
    gap: 2rem;
    margin-bottom: 2rem;
    flex-wrap: wrap;
  }
  .control-group {
    display: flex;
    align-items: baseline;
    gap: 0.5rem;
  }
  .control-group label {
    font-size: 0.75rem;
    font-family: var(--mono);
    color: var(--ink3);
    text-transform: uppercase;
    letter-spacing: 0.08em;
  }
  input[type="range"] {
    -webkit-appearance: none;
    appearance: none;
    width: 180px;
    height: 1px;
    background: var(--ink);
    outline: none;
    cursor: pointer;
  }
  input[type="range"]::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 13px; height: 13px;
    border-radius: 50%;
    background: var(--ink);
    cursor: pointer;
  }
  input[type="range"]::-moz-range-thumb {
    width: 13px; height: 13px;
    border-radius: 50%;
    background: var(--ink);
    border: none;
    cursor: pointer;
  }
  .val {
    font-family: var(--mono);
    font-size: 0.85rem;
    font-weight: 500;
    min-width: 2.5ch;
    text-align: right;
  }
  .money-input {
    font-family: var(--mono);
    font-size: 0.85rem;
    font-weight: 500;
    border: none;
    border-bottom: 1px solid var(--rule);
    background: transparent;
    color: var(--ink);
    padding: 0 0 2px;
    width: 10ch;
    outline: none;
    text-align: right;
  }
  .money-input:focus { border-color: var(--ink); }

  .result { margin-bottom: 2.5rem; }
  .result-value {
    font-family: var(--mono);
    font-size: 2.6rem;
    font-weight: 300;
    letter-spacing: -0.04em;
    line-height: 1;
    color: var(--green);
  }
  .result-value sup {
    font-size: 0.5em;
    vertical-align: super;
    letter-spacing: 0;
  }
  .result-sub {
    font-size: 0.78rem;
    color: var(--ink3);
    margin-top: 0.4rem;
    font-family: var(--mono);
  }
  .result-sub span { color: var(--ink2); }

  .chart-wrap {
    position: relative;
    width: 100%;
    height: 380px;
    margin-bottom: 0.5rem;
  }
  .chart-note {
    font-size: 0.7rem;
    color: var(--ink3);
    font-family: var(--mono);
    text-align: right;
    margin-bottom: 2.5rem;
  }

  .section-rule {
    border: none;
    border-top: 1px solid var(--ink);
    margin-bottom: 1.5rem;
  }
  .section-title {
    font-size: 0.7rem;
    font-family: var(--mono);
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--ink3);
    margin-bottom: 1rem;
  }

  table {
    width: 100%;
    border-collapse: collapse;
  }
  thead th {
    font-family: var(--mono);
    font-weight: 400;
    font-size: 0.65rem;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--ink3);
    text-align: right;
    padding: 0 0 0.6rem;
    border-bottom: 1px solid var(--rule);
  }
  thead th:first-child { text-align: left; }
  tbody td {
    font-family: var(--mono);
    font-size: 0.75rem;
    padding: 0.45rem 0;
    text-align: right;
    border-bottom: 1px solid #eceae5;
    color: var(--ink2);
  }
  tbody td:first-child { text-align: left; color: var(--ink); font-weight: 500; }
  tbody tr { cursor: pointer; }
  tbody tr:hover td { color: var(--ink); }

  .stocks { margin-top: 2.5rem; }
  .stock-row {
    display: flex;
    align-items: center;
    gap: 0.8rem;
    padding: 0.35rem 0;
    font-family: var(--mono);
    font-size: 0.75rem;
  }
  .stock-ticker { width: 5ch; font-weight: 500; color: var(--ink); }
  .stock-bar-bg {
    flex: 1; height: 3px;
    background: var(--rule);
    position: relative;
    border-radius: 1px;
  }
  .stock-bar {
    position: absolute; left: 0; top: 0; height: 100%;
    background: var(--ink);
    border-radius: 1px;
    transition: width 0.5s ease;
  }
  .stock-days { width: 6ch; text-align: right; color: var(--ink3); }
  .stock-ret { width: 8ch; text-align: right; color: var(--green); }

  footer {
    margin-top: 3rem;
    padding-top: 1rem;
    border-top: 1px solid var(--rule);
    font-size: 0.7rem;
    color: var(--ink3);
    line-height: 1.6;
  }

  .loading {
    text-align: center;
    padding: 6rem 0;
    font-style: italic;
    color: var(--ink3);
  }
  .error {
    background: #fef2f2;
    border: 1px solid #fecaca;
    padding: 1rem 1.2rem;
    border-radius: 2px;
    font-size: 0.82rem;
    color: var(--accent);
    margin: 2rem 0;
    line-height: 1.6;
  }
  .error code {
    display: block;
    margin-top: 0.5rem;
    font-family: var(--mono);
    font-size: 0.72rem;
    color: var(--ink2);
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(8px); }
    to { opacity: 1; transform: translateY(0); }
  }
  .fade { animation: fadeIn 0.4s ease both; }
  .f1 { animation-delay: 0.05s; }
  .f2 { animation-delay: 0.1s; }
  .f3 { animation-delay: 0.15s; }
  .f4 { animation-delay: 0.2s; }

  @media (max-width: 600px) {
    html { font-size: 15px; }
    header h1 { font-size: 1.6rem; }
    .result-value { font-size: 2rem; }
    .chart-wrap { height: 260px; }
    .controls { gap: 1rem; }
    input[type="range"] { width: 120px; }
  }
</style>
</head>
<body>

<div class="container" id="app">
  <div class="loading">Loading strategies&hellip;</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
(async function() {
  const app = document.getElementById('app');

  // ── Load JSON ──────────────────────────────────────────────
  let DATA;
  try {
    const r = await fetch('optimal_strategies.json');
    if (!r.ok) throw new Error(`HTTP ${r.status}`);
    DATA = await r.json();
  } catch (e) {
    app.innerHTML = `
      <header><h1>Perfect Hindsight</h1></header>
      <div class="error">
        Could not load <strong>optimal_strategies.json</strong>.<br>
        Place the JSON file alongside this HTML and serve via HTTP:<br>
        <code>python3 -m http.server</code><br>
        <code style="color:var(--ink3);margin-top:2px">${e.message}</code>
      </div>`;
    return;
  }

  const strategies = DATA.strategies;
  const meta = DATA.meta;
  const horizons = Object.keys(strategies).map(Number).sort((a, b) => a - b);
  const maxN = Math.max(...horizons);

  // ── State ──────────────────────────────────────────────────
  let selectedN = Math.min(10, maxN);
  let initial = 10000;

  // ── Formatters (all log10-aware) ───────────────────────────
  // Format a log10 value as a dollar string
  function fmtLog10Dollar(log10val) {
    // log10val is log10(dollar amount)
    if (log10val < 4)  return '$' + Math.round(Math.pow(10, log10val)).toLocaleString();
    if (log10val < 7)  return '$' + (Math.pow(10, log10val - 3)).toFixed(1) + 'K';
    if (log10val < 10) return '$' + (Math.pow(10, log10val - 6)).toFixed(2) + 'M';
    if (log10val < 13) return '$' + (Math.pow(10, log10val - 9)).toFixed(2) + 'B';
    if (log10val < 16) return '$' + (Math.pow(10, log10val - 12)).toFixed(2) + 'T';
    // Beyond trillions: scientific notation
    const mantissa = Math.pow(10, log10val - Math.floor(log10val));
    return '$' + mantissa.toFixed(2) + ' × 10' + superscript(Math.floor(log10val));
  }

  // For the big hero number, richer formatting
  function fmtLog10DollarBig(log10val) {
    if (log10val < 4)  return '$' + Math.round(Math.pow(10, log10val)).toLocaleString();
    if (log10val < 7)  return '$' + (Math.pow(10, log10val - 3)).toFixed(1) + 'K';
    if (log10val < 10) return '$' + (Math.pow(10, log10val - 6)).toFixed(2) + 'M';
    if (log10val < 13) return '$' + (Math.pow(10, log10val - 9)).toFixed(2) + 'B';
    if (log10val < 16) return '$' + (Math.pow(10, log10val - 12)).toFixed(2) + 'T';
    const exp = Math.floor(log10val);
    const mantissa = Math.pow(10, log10val - exp);
    return `$${mantissa.toFixed(2)} × 10<sup>${exp}</sup>`;
  }

  // Format the return multiple
  function fmtLog10Multiple(log10val) {
    if (log10val < 6) {
      const v = Math.pow(10, log10val);
      if (v < 1000) return v.toFixed(1) + '×';
      if (v < 1e6) return (v/1e3).toFixed(1) + 'K×';
      return (v/1e6).toFixed(1) + 'M×';
    }
    return '10' + superscript(log10val.toFixed(1)) + '×';
  }

  // Superscript helper (returns HTML string for inline use, plain for axis)
  function superscript(n) { return '⁰¹²³⁴⁵⁶⁷⁸⁹'.split('').length ? toSuperNum(n) : '^' + n; }
  function toSuperNum(n) {
    const map = {'0':'⁰','1':'¹','2':'²','3':'³','4':'⁴','5':'⁵','6':'⁶','7':'⁷','8':'⁸','9':'⁹','.':'·','-':'⁻'};
    return String(n).split('').map(c => map[c] || c).join('');
  }

  const fmtNum = (n, d=2) => n.toLocaleString(undefined, {
    minimumFractionDigits: d, maximumFractionDigits: d
  });
  const fmtPct = (n) => fmtNum(n) + '%';

  // ── Render shell ───────────────────────────────────────────
  app.innerHTML = `
    <header class="fade">
      <h1>Perfect Hindsight</h1>
      <p>The theoretical maximum return from the S&amp;P 500 with perfect foreknowledge,
      picking the single best stock every trading day. No shorting.</p>
    </header>

    <div class="controls fade f1">
      <div class="control-group">
        <label>Horizon</label>
        <input type="range" id="horizon" min="${horizons[0]}" max="${maxN}" value="${selectedN}">
        <span class="val" id="horizon-val">${selectedN}y</span>
      </div>
      <div class="control-group">
        <label>Starting with</label>
        <span style="font-family:var(--mono);font-size:0.85rem;color:var(--ink3)">$</span>
        <input type="text" class="money-input" id="initial" value="${initial.toLocaleString()}">
      </div>
    </div>

    <div class="result fade f2">
      <div class="result-value" id="big-number"></div>
      <div class="result-sub" id="sub-stats"></div>
    </div>

    <div class="chart-wrap fade f3">
      <canvas id="chart"></canvas>
    </div>
    <div class="chart-note" id="chart-note"></div>

    <hr class="section-rule fade f4">
    <div class="section-title fade f4">All horizons</div>
    <table class="fade f4">
      <thead>
        <tr>
          <th>Years</th>
          <th>Return</th>
          <th>Annualized</th>
          <th>Final Value</th>
          <th>Trades</th>
        </tr>
      </thead>
      <tbody id="table-body"></tbody>
    </table>

    <div class="stocks fade f4">
      <div class="section-title" style="margin-top:0">Most-held stocks</div>
      <div id="stocks-list"></div>
    </div>

    <footer class="fade f4">
      ${meta.membership_method || ''}
      ${meta.survivorship_bias_free
        ? ' Historical membership used — survivorship bias mitigated.'
        : ' Current constituents only — survivorship bias applies.'}<br>
      Reference date: ${meta.reference_date}.
      Data covers ${meta.tickers_with_data || '?'} stocks with price history.
    </footer>
  `;

  // ── Chart ──────────────────────────────────────────────────
  // We plot log10(portfolio value) on a LINEAR axis.
  // Trade metadata is stored in a parallel array for tooltip access.
  let chartTradeData = [];
  const ACTION_LABELS = { b: 'buy', h: 'hold', s: 'switch →' };

  const ctx = document.getElementById('chart').getContext('2d');
  const chart = new Chart(ctx, {
    type: 'line',
    data: { labels: [], datasets: [{
      data: [],
      borderColor: '#1a1a18',
      borderWidth: 1.5,
      pointRadius: 0,
      pointHitRadius: 8,
      fill: { target: 'origin', above: 'rgba(26,26,24,0.04)' },
      tension: 0.1,
    }] },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      animation: { duration: 250 },
      interaction: { mode: 'index', intersect: false },
      plugins: {
        legend: { display: false },
        tooltip: {
          backgroundColor: '#1a1a18',
          titleFont: { family: "'DM Mono', monospace", size: 11, weight: '400' },
          bodyFont: { family: "'DM Mono', monospace", size: 11, weight: '400' },
          padding: { x: 12, y: 10 },
          cornerRadius: 2,
          displayColors: false,
          callbacks: {
            title: (items) => items[0]?.label || '',
            label: (item) => fmtLog10Dollar(item.parsed.y),
            afterLabel: function(item) {
              const t = chartTradeData[item.dataIndex];
              if (!t) return '';
              const ticker = t.t === '__CASH__' ? 'CASH' : t.t;
              const ret = t.r > 0
                ? '+' + (t.r * 100).toFixed(2) + '%'
                : t.r < 0
                  ? (t.r * 100).toFixed(2) + '%'
                  : '0.00%';
              const action = (ACTION_LABELS[t.a] || t.a) + ' ' + ticker;
              return action + '  ' + ret;
            },
          }
        },
      },
      scales: {
        x: {
          grid: { display: false },
          border: { color: '#d8d6d0' },
          ticks: {
            font: { family: "'DM Mono', monospace", size: 10 },
            color: '#9c9c96',
            maxTicksLimit: 8,
            maxRotation: 0,
          },
        },
        y: {
          type: 'linear',
          grid: { color: '#eceae5', drawTicks: false },
          border: { display: false },
          ticks: {
            font: { family: "'DM Mono', monospace", size: 10 },
            color: '#9c9c96',
            padding: 8,
            callback: function(v) {
              if (v < 16) return fmtLog10Dollar(v);
              return '$10' + toSuperNum(Math.round(v));
            },
            maxTicksLimit: 7,
          },
        },
      },
    },
  });

  // ── Master trades + precomputed prefix sums ─────────────────
  const masterTrades = DATA.trades || [];

  // Precompute running log10 cumulative from each possible start index
  // would be O(n²) memory. Instead we'll compute per-horizon on the fly
  // using a prefix sum of the `l` field.
  const log10PrefixSum = new Float64Array(masterTrades.length + 1);
  for (let i = 0; i < masterTrades.length; i++) {
    log10PrefixSum[i + 1] = log10PrefixSum[i] + masterTrades[i].l;
  }
  // log10 cumulative from index start..i = log10PrefixSum[i+1] - log10PrefixSum[start]

  // ── Update ─────────────────────────────────────────────────
  function update() {
    const s = strategies[String(selectedN)];
    if (!s) return;

    const log10initial = Math.log10(initial);
    const log10return = s.log10_total_return;
    const log10final = log10initial + log10return;
    const startIdx = s.trade_start_index;
    const endIdx = masterTrades.length;
    const tradeCount = endIdx - startIdx;

    // Big number
    document.getElementById('big-number').innerHTML = fmtLog10DollarBig(log10final);

    const subParts = [
      `<span>10${toSuperNum(log10return.toFixed(1))}×</span> over ${selectedN}y`,
      `<span>${fmtPct(s.annualized_return_pct)}</span> ann.`,
      `<span>${s.switches.toLocaleString()}</span> trades`,
    ];
    document.getElementById('sub-stats').innerHTML = subParts.join(' · ');

    // Chart: sample ~500 points from the horizon slice
    const step = Math.max(1, Math.floor(tradeCount / 500));
    const labels = [];
    const values = [];
    chartTradeData = [];

    for (let i = startIdx; i < endIdx; i += step) {
      const t = masterTrades[i];
      const log10cum = log10PrefixSum[i + 1] - log10PrefixSum[startIdx];
      labels.push(t.d);
      values.push(log10initial + log10cum);
      chartTradeData.push(t);
    }
    // Ensure last point
    if (endIdx > startIdx) {
      const lastIdx = endIdx - 1;
      const lastT = masterTrades[lastIdx];
      if (labels[labels.length - 1] !== lastT.d) {
        labels.push(lastT.d);
        values.push(log10initial + log10return);
        chartTradeData.push(lastT);
      }
    }

    chart.data.labels = labels;
    chart.data.datasets[0].data = values;
    chart.options.scales.y.min = Math.max(0, log10initial - 0.5);
    chart.update('none');

    document.getElementById('chart-note').textContent = tradeCount > 0
      ? `${s.start_date} → ${s.end_date} · ${s.trading_days.toLocaleString()} days · log\u2081\u2080 scale`
      : 'No trade data';

    // Table
    const tbody = document.getElementById('table-body');
    tbody.innerHTML = horizons.map(n => {
      const st = strategies[String(n)];
      if (!st) return '';
      const active = n === selectedN;
      const l10f = log10initial + st.log10_total_return;
      return `<tr style="${active ? 'background:#f0efeb' : ''}" data-n="${n}">
        <td>${n}</td>
        <td>10${toSuperNum(st.log10_total_return.toFixed(1))}×</td>
        <td>${fmtPct(st.annualized_return_pct)}</td>
        <td>${fmtLog10Dollar(l10f)}</td>
        <td>${st.switches.toLocaleString()}</td>
      </tr>`;
    }).join('');

    tbody.querySelectorAll('tr').forEach(tr => {
      tr.addEventListener('click', () => {
        const n = parseInt(tr.dataset.n);
        if (n) {
          selectedN = n;
          document.getElementById('horizon').value = n;
          document.getElementById('horizon-val').textContent = n + 'y';
          update();
        }
      });
    });

    // Top stocks
    const stocksList = document.getElementById('stocks-list');
    const topStocks = s.top_stocks || [];
    if (!topStocks.length) {
      stocksList.innerHTML = '<div style="font-size:0.75rem;color:var(--ink3);font-family:var(--mono)">No breakdown available</div>';
    } else {
      const maxDays = Math.max(...topStocks.map(s => s.days_held));
      stocksList.innerHTML = topStocks.map(st => `
        <div class="stock-row">
          <span class="stock-ticker">${st.ticker}</span>
          <div class="stock-bar-bg"><div class="stock-bar" style="width:${(st.days_held/maxDays*100)}%"></div></div>
          <span class="stock-days">${st.days_held}d</span>
          <span class="stock-ret">+${fmtNum(st.total_contributed_return_pct, 1)}%</span>
        </div>`).join('');
    }
  }

  // ── Events ─────────────────────────────────────────────────
  document.getElementById('horizon').addEventListener('input', (e) => {
    selectedN = parseInt(e.target.value);
    document.getElementById('horizon-val').textContent = selectedN + 'y';
    update();
  });

  document.getElementById('initial').addEventListener('input', (e) => {
    const v = parseFloat(e.target.value.replace(/[^0-9.]/g, ''));
    if (!isNaN(v) && v > 0) { initial = v; update(); }
  });

  document.getElementById('initial').addEventListener('blur', (e) => {
    e.target.value = initial.toLocaleString();
  });

  update();
})();
</script>
</body>
</html>
